<!DOCTYPE html>
<html>
<head>
    <title>Tourist Guide Staff Page</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#" id="home_nav">Tourist Guide Staff Page</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto" id="nav_items">
            <li class="nav-item">
                <a class="nav-link" href="#" id="articles">Articles</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="destinations">Destinations</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="activities">Activities</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div id="articleTableContainer" style="display: none;">
        <h2>Articles</h2>
        <table class="table">
            <thead>
            <tr>
                <th>id</th>
                <th>Title</th>
                <th>Author</th>
                <th>Date</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
            </thead>
            <tbody id="articleTableBody"></tbody>
        </table>
        <div id="paginationButtons" class="d-flex justify-content-between mt-3">
            <button class="btn btn-primary" id="previousBtn" disabled>Previous</button>
            <button class="btn btn-primary" id="nextBtn">Next</button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        let currentPage = 1;
        const itemsPerPage = 5;

        const token = localStorage.getItem('jwt');
        console.log(token);
        if (token != null) {
            updateNavigation(token);
        } else {
            window.location.href = 'index.html'
        }

        // Function to extract user information from token payload
        function extractUserInfo(token) {
            try {
                const payload = token.split('.')[1];
                const decodedPayload = JSON.parse(atob(payload));
                return decodedPayload;
            } catch (error) {
                console.error('Error decoding token payload:', error);
                return null;
            }
        }

        // Function to update navigation based on user role
        function updateNavigation(token) {
            if (token) {
                const userInfo = extractUserInfo(token);
                if (userInfo) {
                    const tip = userInfo.tip;
                    console.log(userInfo)
                    const firstName = userInfo.firstname;
                    const lastName = userInfo.lastname;
                    const id = userInfo.user_id;
                    $('#home_nav').text(`Welcome, ${firstName} ${lastName}`);
                    if (tip === 'admin') {
                        $('#nav_items').append('<li class="nav-item"><a class="nav-link" href="#" id="users">Users</a></li>');
                    }
                    $('#nav_items').append('<li class="nav-item"><a class="nav-link" href="#" id="logout_nav">Log out</a></li>');
                }
            }
        }

        // Check if JWT token exists in local storage
        // Logout functionality
        $(document).on('click', '#logout_nav', function () {
            localStorage.removeItem('token'); // Remove token from local storage
            window.location.href = 'index.html'; // Redirect to original HTML file
        });

        // Fetch articles when "Articles" button is clicked
        $(document).on('click', '#articles', function () {
            fetchArticles(currentPage);
        });

        // Function to fetch articles with pagination
        function fetchArticles(page) {
            const start = (page) * itemsPerPage;
            // Example fetch request to get articles data
            fetch(`http://localhost:8080/TouristGuide_war_exploded/api/article/latest?page=${start}`)
                .then(response => response.json())
                .then(data => {
                    // Populate the table with article data
                    populateArticleTable(data);
                })
                .catch(error => {
                    console.error('Error fetching articles:', error);
                });
        }

        // Function to populate the article table
        function populateArticleTable(articles) {
            const tableBody = $('#articleTableBody');
            tableBody.empty(); // Clear existing table data
            articles.forEach(article => {
                const row = `
                    <tr>
                        <td>${article.article_id}</td>
                        <td>${article.title}</td>
                        <td>${article.author_name}</td>
                        <td>${formatDate(article.created_at)}</td>
                        <td><button class="btn btn-primary btn-sm edit-article">Edit</button></td>
                        <td><button class="btn btn-danger btn-sm delete-article">Delete</button></td>
                    </tr>
                `;
                tableBody.append(row);
            });
            $('#articleTableContainer').show(); // Show the table container
            // Enable or disable pagination buttons based on current page
            $('#previousBtn').prop('disabled', currentPage === 1);
            $('#nextBtn').prop('disabled', articles.length < itemsPerPage);
        }

        function formatDate(timestamp) {
            var date = new Date(timestamp);
            return date.toDateString();
        }

        // Event listener for delete article buttons
        $(document).on('click', '.delete-article', function () {
            const row = $(this).closest('tr');
            // Implement your delete logic here, e.g., fetch request to delete the article
            // Once the article is deleted, remove the row from the table
            row.remove();
        });

        // Event listener for edit article buttons
        $(document).on('click', '.edit-article', function () {
            // Implement your edit logic here
            // You can get the article ID from the corresponding row and perform edit operations
        });

        // Event listener for Next button
        $(document).on('click', '#nextBtn', function () {
            currentPage++;
            fetchArticles(currentPage);
        });

        // Event listener for Previous button
        $(document).on('click', '#previousBtn', function () {
            currentPage--;
            fetchArticles(currentPage);
        });

        // Initially, disable Previous button
        $('#previousBtn').prop('disabled', true);
    });
</script>


</body>
</html>
